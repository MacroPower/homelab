apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: observability

helmCharts:
  - name: fluent-bit
    repo: https://fluent.github.io/helm-charts
    version: 0.20.8
    releaseName: fluent-bit
    namespace: observability
    valuesInline:
      logLevel: info

      dashboards:
        enabled: true
        labelKey: grafana_dashboard
        namespace: observability

      serviceMonitor:
        enabled: false

      env:
        - name: GRAFANA_CLOUD_LOKI_USER
          valueFrom:
            secretKeyRef:
              name: fluent-bit-credentials
              key: GRAFANA_CLOUD_LOKI_USER
        - name: GRAFANA_CLOUD_LOKI_PASS
          valueFrom:
            secretKeyRef:
              name: fluent-bit-credentials
              key: GRAFANA_CLOUD_LOKI_PASS

      config:
        inputs: |
          [INPUT]
              Name tail
              Path /var/log/containers/*.log
              multiline.parser docker, cri
              Tag kube.*
              Mem_Buf_Limit 100MB
              Skip_Long_Lines On
          [INPUT]
              Name systemd
              Path /var/log/journal
              Tag host.*
              Systemd_Filter _SYSTEMD_UNIT=kubelet.service
              Systemd_Filter _SYSTEMD_UNIT=k3s.service
              Systemd_Filter _SYSTEMD_UNIT=k3s-agent.service
              Read_From_Tail On
        outputs: |
          [OUTPUT]
              Name        loki
              Match       *
              Host        logs-prod-us-central1.grafana.net
              port        443
              tls         on
              tls.verify  on
              http_user   ${GRAFANA_CLOUD_LOKI_USER}
              http_passwd ${GRAFANA_CLOUD_LOKI_PASS}

              labels job=fluentbit
              auto_kubernetes_labels on

      tolerations:
        - effect: NoSchedule
          operator: Exists
        - key: CriticalAddonsOnly
          operator: Exists
        - effect: NoExecute
          operator: Exists

patches:
  - target:
      group: apps
      version: v1
      kind: DaemonSet
      name: fluent-bit
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/livenessProbe
        value:
          exec:
            command:
              - /fluent-bit/bin/fluent-bit
              - --help
      - op: replace
        path: /spec/template/spec/containers/0/readinessProbe
        value:
          exec:
            command:
              - /fluent-bit/bin/fluent-bit
              - --help

resources:
  - secrets.yaml
  - service-monitor.yaml
