apiVersion: v1
kind: ConfigMap
metadata:
  name: twitch-predictions-init-scripts-tpl
  labels:
    app.kubernetes.io/component: scripts
data:
  twitch_predictions_db_init.sh: |
    export PGUSER=postgres
    export PGPASSWORD={{ .POSTGRES_DB_PASS }}
    export PGHOST=timescaledb-single.timescale.svc.cluster.local
    export PGDATABASE=postgres
    export PGSSLMODE=require

    psql <<__SQL__
      \connect postgres
      CREATE ROLE twitchpredictions LOGIN PASSWORD '{{ .TWITCH_PREDICTIONS_DB_PASS }}';
      CREATE DATABASE twitchpredictions OWNER twitchpredictions;

      \connect twitchpredictions
      CREATE EXTENSION pg_stat_statements;

    __SQL__

    exit 0
