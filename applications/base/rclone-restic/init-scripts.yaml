apiVersion: v1
kind: ConfigMap
metadata:
  name: rclone-init-scripts
data:
  init-restic.sh: |
    # Stop any previous jobs.
    curl -v -X POST -H 'Content-Type: application/json' -d '{
    }' http://rclone.restic.svc.cluster.local:5572/job/stopgroup?group=job/restic

    OUTPUT=$(
    curl -v -X POST -H 'Content-Type: application/json' -d '{
      "_async": true,
      "_group": "job/restic",
      "command": "serve",
      "arg": ["restic", "Restic:/"],
      "opt": {
        "addr": ":50001"
      }
    }' http://rclone.restic.svc.cluster.local:5572/core/command
    )

    # Shutdown linkerd.
    curl -v -X POST -d '{"hello":"shutdown"}' http://localhost:4191/shutdown

    echo $OUTPUT

    echo $OUTPUT | grep "jobid"
