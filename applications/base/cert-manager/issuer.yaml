---
apiVersion: kubernetes.crossplane.io/v1alpha1
kind: ProviderConfig
metadata:
  name: kubernetes-provider
spec:
  credentials:
    source: InjectedIdentity

---
apiVersion: apiextensions.crossplane.io/v1
kind: CompositeResourceDefinition
metadata:
  name: cloudflareissuers.cert-manager.crossplane.io
spec:
  group: cert-manager.crossplane.io
  names:
    kind: CloudflareIssuer
    plural: cloudflareissuers
  versions:
    - name: v1alpha1
      served: true
      referenceable: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec: {}
            status:
              type: object
              properties:
                email:
                  type: string

---
apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: cloudflare-issuer
spec:
  compositeTypeRef:
    apiVersion: cert-manager.crossplane.io/v1alpha1
    kind: CloudflareIssuer
  resources:
    - name: secret
      base:
        apiVersion: kubernetes.crossplane.io/v1alpha2
        kind: Object
        spec:
          providerConfigRef:
            name: kubernetes-provider
          managementPolicies: ["Observe"]
          deletionPolicy: Orphan
          forProvider:
            manifest:
              apiVersion: v1
              kind: Secret
              metadata:
                name: cloudflare-credentials
                namespace: cert-manager
      patches:
        - type: ToCompositeFieldPath
          fromFieldPath: "status.atProvider.manifest.data.email"
          toFieldPath: "status.email"
          transforms:
            - type: string
              string:
                type: Convert
                convert: "FromBase64"
    - name: cloudflare-issuer
      base:
        apiVersion: kubernetes.crossplane.io/v1alpha2
        kind: Object
        spec:
          providerConfigRef:
            name: kubernetes-provider
          forProvider:
            manifest:
              apiVersion: cert-manager.io/v1
              kind: ClusterIssuer
              metadata:
                name: cloudflare-issuer
              spec:
                acme:
                  server: https://acme-v02.api.letsencrypt.org/directory
                  privateKeySecretRef:
                    name: cloudflare-issuer-account-key
                  solvers:
                    - dns01:
                        cloudflare:
                          apiTokenSecretRef:
                            name: cloudflare-credentials
                            key: apiToken
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: "status.email"
          toFieldPath: "spec.forProvider.manifest.acme.email"
        - type: FromCompositeFieldPath
          fromFieldPath: "status.email"
          toFieldPath: "spec.forProvider.manifest.spec.acme.solvers[0].dns01.email"

---
apiVersion: cert-manager.crossplane.io/v1alpha1
kind: CloudflareIssuer
metadata:
  name: cloudflare-issuer
  annotations:
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  compositionRef:
    name: cloudflare-issuer
