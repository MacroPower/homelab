apiVersion: tf.upbound.io/v1beta1
kind: Workspace
metadata:
  name: authentik
spec:
  providerConfigRef:
    name: authentik
  writeConnectionSecretToRef:
    namespace: authentik
    name: terraform-workspace-authentik
  forProvider:
    source: Inline
    varFiles:
      - source: SecretKey
        format: HCL
        secretKeyRef:
          namespace: authentik
          name: authentik-cluster-credentials
          key: authentik.tfvars
    module: |
      data "authentik_flow" "default-authorization-flow" {
        slug = "default-provider-authorization-explicit-consent"
      }

      resource "authentik_provider_proxy" "home-domain-forward-auth-provider" {
        name               = "home-domain-forward-auth-provider"
        cookie_domain      = "home.macro.network"
        external_host      = "https://authentik.home.macro.network"
        mode               = "forward_domain"
        authorization_flow = data.authentik_flow.default-authorization-flow.id
      }

      resource "authentik_application" "home-domain-forward-auth-application" {
        name              = "home.macro.network"
        slug              = "home-domain-forward-auth-application"
        protocol_provider = authentik_provider_proxy.home-domain-forward-auth-provider.id
      }

      variable "authentik_cluster_credentials_hcloud" {
        type      = string
        sensitive = true
      }

      resource "authentik_service_connection_kubernetes" "hcloud-service-connection" {
        name       = "hcloud"
        kubeconfig = jsonencode(yamldecode(var.authentik_cluster_credentials_hcloud))
      }

      resource "authentik_provider_proxy" "hcloud-domain-forward-auth-provider" {
        name               = "hcloud-domain-forward-auth-provider"
        cookie_domain      = "macro.network"
        external_host      = "https://authentik.macro.network"
        mode               = "forward_domain"
        authorization_flow = data.authentik_flow.default-authorization-flow.id
      }

      resource "authentik_application" "hcloud-domain-forward-auth-application" {
        name              = "macro.network"
        slug              = "hcloud-domain-forward-auth-application"
        protocol_provider = authentik_provider_proxy.hcloud-domain-forward-auth-provider.id
      }

      resource "authentik_provider_proxy" "seedbox-domain-forward-auth-provider" {
        name               = "seedbox-domain-forward-auth-provider"
        cookie_domain      = "macro.network"
        external_host      = "https://authentik-sb.macro.network"
        mode               = "forward_domain"
        authorization_flow = data.authentik_flow.default-authorization-flow.id
      }

      resource "authentik_application" "seedbox-domain-forward-auth-application" {
        name              = "seedbox.macro.network"
        slug              = "seedbox-domain-forward-auth-application"
        protocol_provider = authentik_provider_proxy.seedbox-domain-forward-auth-provider.id
      }
