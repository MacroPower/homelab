apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: inlets

helmCharts:
  - name: inlets-tcp-client
    repo: https://inlets.github.io/inlets-pro/charts/
    version: '0.5.2'
    releaseName: linkerd-tunnel
    namespace: inlets

    # https://github.com/inlets/inlets-pro/blob/master/chart/inlets-tcp-client/values.yaml
    valuesInline:
      replicaCount: 1

      image:
        # https://github.com/cubed-it/inlets
        repository: ghcr.io/cubed-it/inlets
        pullPolicy: IfNotPresent
        tag: "4.0.0"

      tokenSecretName: linkerd-tunnel-token

      podAnnotations:
        config.linkerd.io/opaque-ports: 6443,4143,4191

      resources:
        limits:
          memory: 128Mi
        requests:
          cpu: 100m
          memory: 128Mi

resources:
  - namespace.yaml
  - secrets.yaml

patches:
  # https://github.com/inlets/inlets-pro/blob/master/chart/inlets-tcp-client/templates/deployment.yaml
  # https://github.com/cubed-it/inlets/blob/master/cmd/client.go
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: linkerd-tunnel-inlets-tcp-client
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/command
        value:
          - inlets
          - client
          - "--url=wss://linkerd-tunnel.macro.network"
          - "--upstream=tcp:6443=kubernetes.default.svc.cluster.local:443,tcp:4143=linkerd-gateway.linkerd-multicluster.svc.cluster.local:4143,tcp:4191=linkerd-gateway.linkerd-multicluster.svc.cluster.local:4191"
          - "--token-from=/etc/inlets/token"
          - "--strict-forwarding=false"
