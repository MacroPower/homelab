apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: inlets

helmCharts:
  - name: inlets-client
    repo: https://jacobcolvin.com/helm-charts/
    version: "0.1.2"
    releaseName: linkerd-tunnel
    namespace: inlets

    # https://github.com/MacroPower/helm-charts/blob/main/charts/inlets-client/values.yaml
    valuesInline:
      inlets:
        url: wss://linkerd-tunnel.macro.network
        strictForwarding: false
        tokenSecretName: linkerd-tunnel-token
        tokenSecretKey: token
        upstreams:
          - target: http://linkerd-gateway.linkerd-multicluster.svc.cluster.local:4191
          - match: tcp:6443
            target: kubernetes.default.svc.cluster.local:443
          - match: tcp:6143
            target: linkerd-gateway.linkerd-multicluster.svc.cluster.local:4143

      podAnnotations:
        config.linkerd.io/skip-outbound-ports: "4143,4191"

      resources:
        limits:
          memory: 128Mi
        requests:
          cpu: 100m
          memory: 128Mi

resources:
  - namespace.yaml
  - secrets.yaml
