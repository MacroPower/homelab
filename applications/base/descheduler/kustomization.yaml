apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: kube-system

helmCharts:
  - name: descheduler
    repo: https://kubernetes-sigs.github.io/descheduler/
    version: 0.25.0
    releaseName: descheduler
    namespace: kube-system
    valuesInline:
      schedule: '*/10 * * * *'

      deschedulerPolicy:
        strategies:
          RemoveDuplicates:
            enabled: true
          RemovePodsHavingTooManyRestarts:
            enabled: true
          RemovePodsViolatingNodeTaints:
            enabled: true
          RemovePodsViolatingNodeAffinity:
            enabled: true
            params:
              nodeAffinityType:
                - requiredDuringSchedulingIgnoredDuringExecution
          RemovePodsViolatingInterPodAntiAffinity:
            enabled: true
          RemovePodsViolatingTopologySpreadConstraint:
            enabled: true
            params:
              includeSoftConstraints: false
          LowNodeUtilization:
            enabled: true
            params:
              nodeResourceUtilizationThresholds:
                thresholds:
                  cpu: 10
                  memory: 30
                targetThresholds:
                  cpu: 50
                  memory: 60

      serviceMonitor:
        enabled: true
        insecureSkipVerify: true
        interval: '1s'
        serverName: null
        metricRelabelings:
          - action: keep
            regex: 'descheduler_(build_info|pods_evicted)'
            sourceLabels: [__name__]
        relabelings:
          - sourceLabels: [__meta_kubernetes_pod_node_name]
            separator: ;
            regex: ^(.*)$
            targetLabel: nodename
            replacement: $1
            action: replace
