apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: media

helmCharts:
  - name: servarr
    repo: https://jacobcolvin.com/helm-charts/
    version: '0.1.2'
    releaseName: sonarr
    namespace: media

    valuesInline:
      nameOverride: sonarr

      image:
        repository: macropower/sonarr
        tag: 'pg-1'

      configSecretName: sonarr-config

      service:
        type: ClusterIP
        port: 8989

      metrics:
        enabled: true

        secretName: sonarr-credentials
        secretKey: SONARR_API_KEY

      serviceMonitor:
        enabled: true

      extraInitContainers:
        - name: init-db
          image: postgres:14
          command:
            - bash
            - /scripts/sonarr_db_init.sh
          volumeMounts:
            - name: sonarr-init-scripts
              mountPath: /scripts

      extraSecretMounts:
        - name: sonarr-init-scripts
          optional: false

      podSecurityContext:
        fsGroup: 1000

resources:
  - secrets.yaml
  - config.yaml
  - config-secrets.yaml
  - init-scripts.yaml
  - init-scripts-secrets.yaml
