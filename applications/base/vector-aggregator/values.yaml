role: Stateless-Aggregator

replicas: 2

customConfig:
  data_dir: /vector-data-dir
  api:
    enabled: true
    address: 0.0.0.0:8686
  sources:
    journal_logs:
      type: vector
      address: 0.0.0.0:6000
      version: "2"
    kubernetes_logs:
      type: vector
      address: 0.0.0.0:6010
      version: "2"
    vector_metrics:
      type: internal_metrics
  transforms:
    kubernetes_logs_remap:
      type: remap
      inputs:
        - kubernetes_logs
      source: |
        # Standardize 'app' index
        .custom_app_name = .pod_labels."app.kubernetes.io/name" || .pod_labels.app || .pod_labels."k8s-app" || "unknown"
  sinks:
    loki_journal:
      type: loki
      inputs:
        - journal_logs
      endpoint: http://loki-gateway.loki.svc.cluster.local:80
      encoding:
        codec: json
      batch:
        max_bytes: 2049000
      out_of_order_action: accept
      remove_label_fields: true
      remove_timestamp: true
      labels:
        hostname: >-
          {{`{{ host }}`}}
    loki_kubernetes:
      type: loki
      inputs:
        - kubernetes_logs_remap
      endpoint: http://loki-gateway.loki.svc.cluster.local:80
      encoding:
        codec: raw_message
      batch:
        max_bytes: 2049000
      out_of_order_action: accept
      remove_label_fields: true
      remove_timestamp: true
      labels:
        app: >-
          {{`{{ custom_app_name }}`}}
        component: >-
          {{`{{ .pod_labels."app.kubernetes.io/component" }}`}}
        container: >-
          {{`{{ .container_name }}`}}
        instance: >-
          {{`{{ .pod_labels."app.kubernetes.io/instance" }}`}}
        namespace: >-
          {{`{{ .pod_namespace }}`}}
        node: >-
          {{`{{ .pod_node_name }}`}}
        pod: >-
          {{`{{ .pod_name }}`}}
        source: vector
        stream: >-
          {{`{{ .stream }}`}}
    prom_exporter:
      type: prometheus_exporter
      inputs:
        - vector_metrics
      address: 0.0.0.0:9090

resources:
  requests:
    cpu: 10m
    memory: 100Mi
  limits:
    memory: 100Mi
