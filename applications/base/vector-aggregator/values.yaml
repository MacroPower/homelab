role: Stateless-Aggregator

replicas: 2

customConfig:
  data_dir: /vector-data-dir
  api:
    enabled: true
    address: 0.0.0.0:8686
  sources:
    journal_logs:
      type: vector
      address: 0.0.0.0:6000
      version: "2"
    kubernetes_logs:
      type: vector
      address: 0.0.0.0:6010
      version: "2"
    pfsense_logs:
      type: syslog
      address: 0.0.0.0:5140
      mode: udp
    vector_metrics:
      type: internal_metrics
  transforms:
    kubernetes_logs_remap:
      type: remap
      inputs:
        - kubernetes_logs
      source: |
        # Standardize 'app' index
        .custom_app_name = .pod_labels."app.kubernetes.io/name" || .pod_labels.app || .pod_labels."k8s-app" || "unknown"
        # Standardize 'component' index
        .custom_component_name = .pod_labels."app.kubernetes.io/component" || .pod_labels.component || .pod_labels."k8s-component" || "unknown"
        # Standardize 'instance' index
        .custom_instance_name = .pod_labels."app.kubernetes.io/instance" || .pod_labels.instance || .pod_labels."k8s-instance" || "unknown"
    pfsense_logs_remap:
      type: remap
      inputs:
        - pfsense_logs
      source: |
        # Taken from https://github.com/billimek/k8s-gitops/blob/master/logs/vector/aggregator.yaml
        msg = parse_csv!(string!(.message))
        # Only parse IPv4 / IPv6
        if msg[8] == "4" || msg[8] == "6" {
          .filter_interface = msg[4]
          .filter_direction = msg[7]
          .filter_action = msg[6]
          .filter_ip_version = msg[8]
          .filter_protocol = msg[16]
          .filter_source_ip = msg[18]
          .filter_destination_ip = msg[19]
          if (msg[16] == "icmp" || msg[16] == "igmp" || msg[16] == "gre") {
            .filter_data = msg[20]
          } else {
            .filter_source_port = msg[20]
            .filter_destination_port = msg[21]
            .filter_data_length = msg[22]
            if msg[8] == "4" && msg[16] == "tcp" {
              .filter_tcp_flags = msg[23]
            }
          }
        }
  sinks:
    loki_journal:
      type: loki
      inputs:
        - journal_logs
      endpoint: http://loki-gateway.loki.svc.cluster.local:80
      encoding:
        codec: json
      batch:
        max_bytes: 2049000
      out_of_order_action: accept
      remove_label_fields: true
      remove_timestamp: true
      labels:
        hostname: >-
          {{`{{ host }}`}}
        source: kubernetes-journal
    loki_kubernetes:
      type: loki
      inputs:
        - kubernetes_logs_remap
      endpoint: http://loki-gateway.loki.svc.cluster.local:80
      encoding:
        codec: raw_message
      batch:
        max_bytes: 2049000
      out_of_order_action: accept
      remove_label_fields: true
      remove_timestamp: true
      labels:
        app: >-
          {{`{{ custom_app_name }}`}}
        component: >-
          {{`{{ custom_component_name }}`}}
        container: >-
          {{`{{ .container_name }}`}}
        instance: >-
          {{`{{ custom_instance_name }}`}}
        namespace: >-
          {{`{{ .pod_namespace }}`}}
        node: >-
          {{`{{ .pod_node_name }}`}}
        pod: >-
          {{`{{ .pod_name }}`}}
        source: kubernetes-pods
        stream: >-
          {{`{{ .stream }}`}}
    loki_pfsense:
      type: loki
      inputs:
        - pfsense_logs_remap
      endpoint: http://loki-gateway.loki.svc.cluster.local:80
      encoding:
        codec: json
      batch:
        max_bytes: 2049000
      out_of_order_action: accept
      labels:
        source: pfsense
    prom_exporter:
      type: prometheus_exporter
      inputs:
        - vector_metrics
      address: 0.0.0.0:9090

resources:
  requests:
    cpu: 10m
    memory: 100Mi
  limits:
    memory: 100Mi
