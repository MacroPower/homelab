apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: pgadmin

helmCharts:
  - name: pgadmin4
    repo: https://helm.runix.net
    version: 1.13.1
    releaseName: pgadmin4
    namespace: pgadmin
    valuesInline:
      serviceAccount:
        create: true

      serverDefinitions:
        enabled: false

      env:
        variables:
          - name: PGADMIN_SERVER_JSON_FILE
            value: /pgadmin4/servers.json

      extraConfigmapMounts:
        - name: pg-servers
          mountPath: /pgadmin4/servers.json
          subPath: servers.json
          configMap: pg-servers
          readOnly: true

      persistentVolume:
        enabled: false

resources:
  - namespace.yaml
  - secrets.yaml
  - servers.yaml

patchesStrategicMerge:
  - |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: pgadmin4
    spec:
      template:
        spec:
          containers:
            - name: pgadmin4
              env:
                - name: PGADMIN_DEFAULT_EMAIL
                  value: null
                  valueFrom:
                    secretKeyRef:
                      key: PGADMIN_DEFAULT_EMAIL
                      name: pgadmin-credentials
                - name: PGADMIN_DEFAULT_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      key: PGADMIN_DEFAULT_PASSWORD
                      name: pgadmin-credentials
