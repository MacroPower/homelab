apiVersion: v1
kind: ConfigMap
metadata:
  name: couchdb-init-scripts
data:
  init-dbs.sh: |
    BASE_URL="http://single-couchdb.data.svc.cluster.local:5984"
    CREDS="$(echo -n "${COUCHDB_USER}:${COUCHDB_PASSWORD}" | base64)"
    AUTH_HEADER="Authorization: Basic $CREDS"

    echo "Testing connectivity..."
    curl -X GET $BASE_URL -H "$AUTH_HEADER"

    echo "Showing databases..."
    curl -X GET "${BASE_URL}/_all_dbs" -H "$AUTH_HEADER"

    echo "Creating databases..."
    curl -X PUT "${BASE_URL}/nomie" -H "$AUTH_HEADER"

    NOMIE_USER='{"name":"nomie","type":"user","roles":[],"password":"'$COUCHDB_NOMIE_PASSWORD'"}'
    NOMIE_SEC='{"members":{"roles":["_admin"]},"admins":{"roles":["_admin"],"names":["nomie"]}}'

    curl -X PUT "${BASE_URL}/_users/org.couchdb.user%3Anomie" -H "$AUTH_HEADER" --data-raw "$(echo -n $NOMIE_USER | sed -e 's/"/\\"/g')"
    curl -X PUT "${BASE_URL}/nomie/_security" -H "$AUTH_HEADER" --data-raw "$(echo -n $NOMIE_SEC | sed -e 's/"/\\"/g')"

    echo "Showing databases..."
    curl -X GET "${BASE_URL}/_all_dbs" -H "$AUTH_HEADER"
