---
apiVersion: kyverno.io/v1
kind: Policy
metadata:
  name: patch-ocis-oidc
spec:
  rules:
    - name: add-web-env-vars
      match:
        any:
          - resources:
              kinds:
                - Deployment
              names:
                - web
      preconditions:
        all:
          - key: "{{request.operation || 'BACKGROUND'}}"
            operator: AnyIn
            value: [CREATE]
      mutate:
        patchesJson6902: |-
          - op: add
            path: /spec/template/spec/containers/0/env/-
            value:
              name: WEB_OIDC_SCOPE
              value: "openid profile email groups"

    - name: update-proxy-env-vars
      match:
        any:
          - resources:
              kinds:
                - Deployment
              names:
                - proxy
      preconditions:
        all:
          - key: "{{request.operation || 'BACKGROUND'}}"
            operator: AnyIn
            value: [CREATE, UPDATE]
      mutate:
        patchStrategicMerge:
          spec:
            template:
              spec:
                containers:
                  - (name): proxy
                    env:
                      - (name): PROXY_OIDC_ISSUER
                        value: "https://authentik.home.macro.network/application/o/owncloud-web/"

    - name: add-proxy-env-vars
      match:
        any:
          - resources:
              kinds:
                - Deployment
              names:
                - proxy
      preconditions:
        all:
          - key: "{{request.operation || 'BACKGROUND'}}"
            operator: AnyIn
            value: [CREATE]
      mutate:
        patchesJson6902: |-
          - op: add
            path: /spec/template/spec/containers/0/env/-
            value:
              name: PROXY_OIDC_REWRITE_WELLKNOWN
              value: "true"
          - op: add
            path: /spec/template/spec/containers/0/env/-
            value:
              name: PROXY_USER_OIDC_CLAIM
              value: "preferred_username"
          - op: add
            path: /spec/template/spec/containers/0/env/-
            value:
              name: PROXY_USER_CS3_CLAIM
              value: "username"
          - op: add
            path: /spec/template/spec/containers/0/env/-
            value:
              name: PROXY_OIDC_ACCESS_TOKEN_VERIFY_METHOD
              value: "none"
