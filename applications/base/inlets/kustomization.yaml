apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: inlets

helmCharts:
  - name: inlets-tcp-server
    repo: https://inlets.github.io/inlets-pro/charts/
    version: '0.6.1'
    releaseName: linkerd-tunnel
    namespace: inlets

    # https://github.com/inlets/inlets-pro/blob/master/chart/inlets-tcp-server/values.yaml
    valuesInline:
      replicaCount: 1

      image:
        # https://github.com/cubed-it/inlets
        repository: ghcr.io/cubed-it/inlets
        pullPolicy: IfNotPresent
        tag: "4.0.0"

      tokenSecretName: linkerd-tunnel-token

      podAnnotations:
        config.linkerd.io/admin-port: 6191
        config.linkerd.io/inbound-port: 6143
        config.linkerd.io/opaque-ports: 6443,4143,4191

      controlPlane:
        type: ClusterIP
        port: 8123

      dataPlane:
        type: ClusterIP
        ports:
        - targetPort: 8122
          protocol: TCP
          name: default
          port: 8122
        - targetPort: 6443
          protocol: TCP
          name: kube
          port: 6443
        - targetPort: 4143
          protocol: TCP
          name: linkerd-proxy
          port: 4143
        - targetPort: 4191
          protocol: TCP
          name: linkerd-admin
          port: 4191

      ingress:
        domain: linkerd-tunnel.macro.network
        annotations:
          'kubernetes.io/ingress.class': 'traefik'
          'external-dns.alpha.kubernetes.io/hostname': 'linkerd-tunnel.macro.network'
          'external-dns.alpha.kubernetes.io/cloudflare-proxied': 'false'
          'traefik.ingress.kubernetes.io/router.tls.options': 'kube-system-no-client-auth@kubernetescrd'
          'traefik.ingress.kubernetes.io/router.entrypoints': 'websecure'
          'cert-manager.io/issuer': 'letsencrypt-prod'

      resources:
        limits:
          memory: 128Mi
        requests:
          cpu: 100m
          memory: 128Mi

resources:
  - namespace.yaml
  - secrets.yaml
  - issuer.yaml

patches:
  # https://github.com/inlets/inlets-pro/blob/master/chart/inlets-tcp-server/templates/deployment.yaml
  # https://github.com/cubed-it/inlets/blob/master/cmd/server.go
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: linkerd-tunnel
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/command
        value:
          - inlets
          - server
          - "--port=8122"
          - "--control-port=8123"
          - "--disable-transport-wrapping"
          - "--token-from=/etc/inlets/token"
