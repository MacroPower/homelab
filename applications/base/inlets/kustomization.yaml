apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: inlets

helmCharts:
  - name: inlets-server
    repo: https://jacobcolvin.com/helm-charts/
    version: "0.1.1"
    releaseName: linkerd-tunnel
    namespace: inlets

    # https://github.com/MacroPower/helm-charts/blob/main/charts/inlets-server/values.yaml
    valuesInline:
      inlets:
        port: 6191
        disableTransportWrapping: true
        tokenSecretName: linkerd-tunnel-token
        tokenSecretKey: token

      service:
        data-plane:
          type: ClusterIP
          ports:
            kube:
              port: 6443
              protocol: TCP
            admin:
              port: 6191
              protocol: TCP
        data-plane-lb:
          type: LoadBalancer
          annotations:
            metallb.universe.tf/allow-shared-ip: main
          ports:
            proxy:
              port: 6143
              protocol: TCP

      ingress:
        main:
          enabled: true
          hosts:
            - host: linkerd-tunnel.macro.network
              paths:
                - path: /
                  pathType: Prefix
          tls:
            - hosts: [linkerd-tunnel.macro.network]
              secretName: linkerd-tunnel-cert
          annotations:
            "external-dns.alpha.kubernetes.io/hostname": "linkerd-tunnel.macro.network"
            "external-dns.alpha.kubernetes.io/cloudflare-proxied": "false"
            "traefik.ingress.kubernetes.io/router.tls.options": "kube-system-no-client-auth@kubernetescrd"
            "traefik.ingress.kubernetes.io/router.entrypoints": "websecure"
            "cert-manager.io/issuer": "letsencrypt-prod"

      resources:
        limits:
          memory: 128Mi
        requests:
          cpu: 100m
          memory: 128Mi

resources:
  - namespace.yaml
  - secrets.yaml
  - issuer.yaml
