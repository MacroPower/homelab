apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: inlets

helmCharts:
  - name: template
    repo: https://jacobcolvin.com/helm-charts/
    version: "0.1.1"
    releaseName: linkerd-tunnel
    namespace: inlets

    # https://github.com/inlets/inlets-pro/blob/master/chart/inlets-tcp-server/values.yaml
    valuesInline:
      image:
        # https://github.com/cubed-it/inlets
        repository: ghcr.io/cubed-it/inlets
        pullPolicy: IfNotPresent
        tag: "4.0.0"

      controller:
        replicas: 1

      command:
        - inlets
        - server
        - "--port=6191"
        - "--control-port=8123"
        - "--disable-transport-wrapping"
        - "--token-from=/etc/inlets/token"

      service:
        main:
          type: ClusterIP
          ports:
            http:
              port: 8123
              protocol: TCP
        data-plane:
          type: ClusterIP
          ports:
            kube:
              port: 6443
              protocol: TCP
            admin:
              port: 6191
              protocol: TCP
        data-plane-lb:
          type: LoadBalancer
          annotations:
            metallb.universe.tf/allow-shared-ip: main
          ports:
            proxy:
              port: 6143
              protocol: TCP

      serviceAccount:
        create: true
        name: ""

      persistence:
        config:
          enabled: true
          name: linkerd-tunnel-token
          type: secret
          mountPath: /etc/inlets
          readOnly: true

      podAnnotations:
        config.linkerd.io/skip-outbound-ports: "6443,6143,6191"
        config.linkerd.io/enable-debug-sidecar: "true"

      ingress:
        main:
          enabled: true
          hosts:
            - host: linkerd-tunnel.macro.network
              paths:
                - path: /
                  pathType: Prefix
          tls:
            - hosts: [linkerd-tunnel.macro.network]
              secretName: linkerd-tunnel-cert
          annotations:
            "external-dns.alpha.kubernetes.io/hostname": "linkerd-tunnel.macro.network"
            "external-dns.alpha.kubernetes.io/cloudflare-proxied": "false"
            "traefik.ingress.kubernetes.io/router.tls.options": "kube-system-no-client-auth@kubernetescrd"
            "traefik.ingress.kubernetes.io/router.entrypoints": "websecure"
            "cert-manager.io/issuer": "letsencrypt-prod"

      probes:
        liveness:
          enabled: false
        readiness:
          enabled: false
        startup:
          enabled: false

      resources:
        limits:
          memory: 128Mi
        requests:
          cpu: 100m
          memory: 128Mi

resources:
  - namespace.yaml
  - secrets.yaml
  - issuer.yaml
