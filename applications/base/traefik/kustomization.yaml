apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: kube-system

helmCharts:
  - name: traefik
    repo: https://helm.traefik.io/traefik
    version: 21.2.0
    releaseName: traefik
    includeCRDs: true

    # https://github.com/traefik/traefik-helm-chart/blob/master/traefik/values.yaml
    valuesInline:
      deployment:
        kind: Deployment
        replicas: 3

        annotations:
          'sidecar.jaegertracing.io/inject': 'true'

      additionalArguments:
        - --serverstransport.insecureskipverify=true
        - --log.level=DEBUG

      service:
        annotations:
          metallb.universe.tf/allow-shared-ip: main

      tracing:
        jaeger:
          samplingServerURL: http://localhost:5778/sampling
          samplingType: const
          samplingParam: 1.0
          localAgentHostPort: 127.0.0.1:6831

      providers:
        kubernetesIngress:
          enabled: true
          publishedService:
            enabled: true
            pathOverride: 'kube-system/traefik'

      ports:
        websecure:
          tls:
            enabled: true

      tlsStore:
        default:
          defaultCertificate:
            secretName: cloudflare-origin-ca

      tlsOptions:
        default:
          clientAuth:
            secretNames:
              - cloudflare-authenticated-origin-pull-ca
            clientAuthType: RequireAndVerifyClientCert
        'no-client-auth': {}

resources:
  - secrets.yaml
