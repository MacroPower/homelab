apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: observability

helmCharts:
  - name: grafana
    repo: https://grafana.github.io/helm-charts
    version: 6.39.0
    releaseName: grafana
    namespace: observability
    valuesInline:
      annotations:
        'sidecar.jaegertracing.io/inject': 'true'

      env:
        JAEGER_AGENT_HOST: localhost
        JAEGER_AGENT_PORT: '6831'
        ANALYTICS_REPORTING_ENABLED: 'false'

      admin:
        existingSecret: grafana-credentials
        userKey: GRAFANA_ADMIN_USER
        passwordKey: GRAFANA_ADMIN_PASS

      sidecar:
        resources:
          requests:
            cpu: 50m
            memory: 128Mi
          limits:
            memory: 128Mi
        alerts:
          enabled: false
          label: grafana_alert
        dashboards:
          enabled: true
          label: grafana_dashboard
          provider:
            allowUiUpdates: true
        datasources:
          enabled: true
          label: grafana_datasource
        plugins:
          enabled: true
          label: grafana_plugin

      resources:
        requests:
          cpu: 50m
          memory: 128Mi
        limits:
          memory: 128Mi

configMapGenerator:
  - name: grafana-dashboard-grafana-cloud-usage
    behavior: create
    files:
      - grafana-cloud-usage.json=dashboards/grafana-cloud-usage.json

  - name: grafana-dashboard-k8s-home
    behavior: create
    files:
      - k8s-home.json=dashboards/k8s-home.json

  - name: grafana-dashboard-k8s-oversized-requests
    behavior: create
    files:
      - k8s-oversized-requests.json=dashboards/k8s-oversized-requests.json

  # https://grafana.com/grafana/dashboards/14584-argocd/
  - name: grafana-dashboard-argocd
    behavior: create
    files:
      - argocd.json=dashboards/argocd.json

  # https://github.com/onedr0p/exportarr/tree/master/examples/grafana
  - name: grafana-dashboard-servarr
    behavior: create
    files:
      - servarr.json=dashboards/servarr.json

  # https://github.com/dotdc/grafana-dashboards-kubernetes
  - name: grafana-dashboard-k8s-system-api-server
    behavior: create
    files:
      - k8s-system-api-server.json=dashboards/k8s-system-api-server.json
  - name: grafana-dashboard-k8s-system-coredns
    behavior: create
    files:
      - k8s-system-coredns.json=dashboards/k8s-system-coredns.json
  - name: grafana-dashboard-k8s-views-global
    behavior: create
    files:
      - k8s-views-global.json=dashboards/k8s-views-global.json
  - name: grafana-dashboard-k8s-views-namespaces
    behavior: create
    files:
      - k8s-views-namespaces.json=dashboards/k8s-views-namespaces.json
  - name: grafana-dashboard-k8s-views-nodes
    behavior: create
    files:
      - k8s-views-nodes.json=dashboards/k8s-views-nodes.json
  - name: grafana-dashboard-k8s-views-pods
    behavior: create
    files:
      - k8s-views-pods.json=dashboards/k8s-views-pods.json

generatorOptions:
  labels:
    grafana_dashboard: '1'

resources:
  - secrets.yaml
  - datasources/grafana-cloud.yaml
  - datasources/grafana-cloud-secrets.yaml
