apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: observability

helmCharts:
  - name: grafana
    repo: https://grafana.github.io/helm-charts
    version: 6.39.0
    releaseName: grafana
    namespace: observability
    valuesInline:
      annotations:
        'sidecar.jaegertracing.io/inject': 'true'

      env:
        JAEGER_AGENT_HOST: localhost
        JAEGER_AGENT_PORT: '6831'
        ANALYTICS_REPORTING_ENABLED: 'false'

      admin:
        existingSecret: grafana-credentials
        userKey: GRAFANA_ADMIN_USER
        passwordKey: GRAFANA_ADMIN_PASS

      sidecar:
        resources:
          limits:
            cpu: 100m
            memory: 100Mi
          requests:
            cpu: 50m
            memory: 50Mi
        alerts:
          enabled: false
          label: grafana_alert
        dashboards:
          enabled: true
          label: grafana_dashboard
          provider:
            allowUiUpdates: true
        datasources:
          enabled: true
          label: grafana_datasource
        plugins:
          enabled: true
          label: grafana_plugin

      resources:
        limits:
          cpu: 100m
          memory: 128Mi
        requests:
          cpu: 50m
          memory: 128Mi

configMapGenerator:
  - name: grafana-dashboard-grafana-cloud-usage
    behavior: add
    files:
      - grafana-cloud-usage.json=dashboards/grafana-cloud-usage.json

  - name: grafana-dashboard-k8s-home
    behavior: add
    files:
      - k8s-home.json=dashboards/k8s-home.json

  # https://grafana.com/grafana/dashboards/14584-argocd/
  - name: grafana-dashboard-argocd
    behavior: add
    files:
      - argocd.json=dashboards/argocd.json

  # https://github.com/onedr0p/exportarr/tree/master/examples/grafana
  - name: grafana-dashboard-servarr
    behavior: add
    files:
      - servarr.json=dashboards/servarr.json

generatorOptions:
  labels:
    grafana_dashboard: '1'

resources:
  - secrets.yaml
  - datasources/grafana-cloud.yaml
  - datasources/grafana-cloud-secrets.yaml
