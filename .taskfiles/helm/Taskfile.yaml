---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

tasks:
  dep-up:
    desc: Update Helm chart dependencies
    requires:
      vars: [CHART_PATH]
    preconditions:
      - &requireHelmCli
        sh: command -v helm
        msg: |
          Helm CLI not found, you can install it with:

          brew install helm
    cmds:
      - helm dependency update {{.CHART_PATH}}

  lint-chart:
    desc: Lint Helm chart
    requires:
      vars: [CHART_PATH, PARAMS]
    preconditions:
      - *requireHelmCli
      - sh: command -v ct
        msg: |
          Chart Testing (ct) CLI not found, you can install it with:

          brew install chart-testing
      - sh: command -v yamllint
        msg: |
          yamllint not found, you can install it with:

          brew install yamllint
    cmds:
      - >-
        ct lint
        --chart-dirs="{{.CHART_PATH}}"
        --charts="{{.CHART_PATH}}"
        --helm-dependency-extra-args="--skip-refresh"
        --helm-lint-extra-args="--quiet --with-subcharts {{.PARAMS}}"
        --validate-maintainers=false
