---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

tasks:
  sync:
    desc: Sync an ExternalSecret
    summary: |
      Args:
        NS: Namespace the ExternalSecret is in (default: default)
        SECRET: Secret to sync (required)
    cmd: kubectl -n {{.NS}} annotate externalsecret {{.SECRET}} force-sync=$(date +%s) --overwrite
    requires:
      vars:
        - SECRET
    vars:
      NS: '{{.NS | default "default"}}'
    preconditions:
      - msg: ExternalSecret `{{.SECRET}}` could not be found in namespace `{{.NS}}`.
        sh: kubectl -n {{.NS}} get externalsecret {{.SECRET}}

  sync-all:
    desc: Sync all ExternalSecrets
    cmds:
      - for: { var: SECRETS, split: "" }
        task: sync
        vars:
          NS: '{{$a := split "|" .ITEM}}{{$a._0}}'
          SECRET: '{{$a := split "|" .ITEM}}{{$a._1}}'
    vars:
      SECRETS:
        sh: kubectl get externalsecret --all-namespaces --no-headers -A | awk '{print $1 "|" $2}'
