# yaml-language-server: $schema=../../../../charts/descheduler/values.schema.json

schedule: "*/10 * * * *"

deschedulerPolicy:
  profiles:
    - name: default
      pluginConfig:
        - name: DefaultEvictor
          args:
            nodeFit: true
        ## Deschedule plugins
        ##
        - name: RemovePodsHavingTooManyRestarts
          args:
            podRestartThreshold: 100
            includingInitContainers: true
        - name: RemoveFailedPods
          args:
            includingInitContainers: true
            minPodLifetimeSeconds: 3600
        - name: RemovePodsViolatingNodeAffinity
          args:
            nodeAffinityType:
              - requiredDuringSchedulingIgnoredDuringExecution
              - preferredDuringSchedulingIgnoredDuringExecution
        - name: RemovePodsViolatingNodeTaints
          args:
            includePreferNoSchedule: true
        - name: RemovePodsViolatingInterPodAntiAffinity
        ## Balance plugins
        ##
        - name: RemovePodsViolatingTopologySpreadConstraint
          args:
            constraints: [DoNotSchedule, ScheduleAnyway]
        - name: LowNodeUtilization
          args:
            thresholds:
              cpu: 20
              memory: 20
              pods: 20
            targetThresholds:
              cpu: 50
              memory: 50
              pods: 50
      plugins:
        balance:
          enabled:
            - RemovePodsViolatingTopologySpreadConstraint
            - LowNodeUtilization
        deschedule:
          enabled:
            - RemovePodsHavingTooManyRestarts
            - RemoveFailedPods
            - RemovePodsViolatingNodeTaints
            - RemovePodsViolatingNodeAffinity
            - RemovePodsViolatingInterPodAntiAffinity

resources:
  requests:
    cpu: 50m
    memory: 250Mi
  limits:
    memory: 250Mi

serviceMonitor:
  enabled: false
  insecureSkipVerify: true
  interval: 1s
  serverName:
  metricRelabelings:
    - action: keep
      regex: descheduler_(build_info|pods_evicted)
      sourceLabels: [__name__]
  relabelings:
    - sourceLabels: [__meta_kubernetes_pod_node_name]
      separator: ;
      regex: ^(.*)$
      targetLabel: nodename
      replacement: $1
      action: replace
